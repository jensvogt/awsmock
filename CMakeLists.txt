cmake_minimum_required(VERSION 3.22)
project(awsmock)

# Defaults
set(CMAKE_CXX_STANDARD 23)
set(CMAKE_BUILD_PARALLEL_LEVEL 30)
if (WIN32)
    set(CMAKE_WINDOWS_EXPORT_ALL_SYMBOLS 1)
    add_definitions(-D_WIN32_WINNT=0x0A00)
    add_compile_options(/MP16)
else ()
    set(CMAKE_CXX_FLAGS_RELEASE "-O3")
    set(CMAKE_CXX_FLAGS_DEBUG "-g")
endif ()

# Doxygen
if (WIN32)
    option(BUILD_DOCUMENTATION "Create and install the HTML based API documentation (requires Doxygen and dot) " OFF)
else ()
    option(BUILD_DOCUMENTATION "Create and install the HTML based API documentation (requires Doxygen and dot) " ON)
endif ()

# Current version
file(READ "${CMAKE_SOURCE_DIR}/version.txt" PROJECT_VER)
string(STRIP "${PROJECT_VER}" PROJECT_VERSION)
string(TIMESTAMP PROJECT_BUILDDATE "%d-%m-%Y")
configure_file("${CMAKE_SOURCE_DIR}/src/core/include/awsmock/core/Version.h.in" "${CMAKE_SOURCE_DIR}/src/core/include/awsmock/core/Version.h" @ONLY)

# Build message
message("-- Building ${PROJECT_NAME} v${PROJECT_VERSION} type: ${CMAKE_BUILD_TYPE}, install prefix: ${CMAKE_INSTALL_PREFIX}")

# Set default build type release
if (NOT CMAKE_BUILD_TYPE)
    set(CMAKE_BUILD_TYPE Release CACHE PATH "" FORCE)
endif ()

# Testing
enable_testing()

# Set includes and libraries
if (WIN32)
    set(INC_BSON_CXX D:/work/lib/include/bsoncxx/v_noabi)
    set(INC_MONGO_CXX D:/work/lib/include/mongocxx/v_noabi)
    set(LIB_BSON_CXX bsoncxx-v_noabi-rhs-x64-v143-md.lib)
    set(LIB_MONGO_CXX mongocxx-v_noabi-rhs-x64-v143-md.lib)
    set(LIB_BOOST_LOCALE libboost_locale-vc143-mt-x64-1_87.lib)
    set(LIB_BOOST_FILESYSTEM libboost_locale-vc143-mt-x64-1_87.lib)
    set(LIB_BOOST_URL libboost_url-vc143-mt-x64-1_87.lib)
    set(LIB_BOOST_PROGRAM_OPTIONS boost_program_options-vc143-mt-x64-1_87.lib)
    set(LIB_SSL libssl.lib)
    set(LIB_CRYPTO libcrypto.lib)
    set(LIB_ARCHIVE archive.lib)
    set(LIBRARY_OUTPUT_PATH ${CMAKE_BINARY_DIR})
    set(WINDOWS_EXPORT_ALL_SYMBOLS ON)
else ()
    set(INC_BSON_CXX /usr/local/include/bsoncxx/v_noabi)
    set(INC_MONGO_CXX /usr/local/include/mongocxx/v_noabi)
    set(LIB_BSON_CXX bsoncxx)
    set(LIB_MONGO_CXX mongocxx)
    set(LIB_BOOST_LOCALE boost_locale)
    set(LIB_BOOST_FILESYSTEM boost_filesystem)
    set(LIB_BOOST_URL boost_url)
    set(LIB_BOOST_PROGRAM_OPTIONS boost_program_options)
    set(LIB_SSL ssl)
    set(LIB_CRYPTO crypto)
    set(LIB_ARCHIVE archive)
endif ()

if (APPLE)
    set(CMAKE_MACOSX_RPATH true)
endif ()

add_subdirectory(src/core)
add_subdirectory(src/db)
add_subdirectory(src/dto)
add_subdirectory(src/service)
add_subdirectory(src/manager)
add_subdirectory(src/controller)
add_subdirectory(docs)

if (NOT WIN32)
    install(DIRECTORY DESTINATION /usr/local/awsmock)
    install(DIRECTORY DESTINATION /usr/local/awsmock/bin)
    install(DIRECTORY DESTINATION /usr/local/awsmock/lib)
    install(DIRECTORY DESTINATION /usr/local/awsmock/etc)
    install(DIRECTORY DESTINATION /usr/local/awsmock/log)
    install(DIRECTORY DESTINATION /usr/local/awsmock/frontend)
    install(DIRECTORY DESTINATION /usr/local/awsmock/samples)
    install(DIRECTORY DESTINATION /usr/local/awsmock/data)
    install(DIRECTORY DESTINATION /usr/local/awsmock/data/s3)
    install(DIRECTORY DESTINATION /usr/local/awsmock/data/sqs)
    install(DIRECTORY DESTINATION /usr/local/awsmock/data/sns)
    install(DIRECTORY DESTINATION /usr/local/awsmock/data/lambda)
    install(DIRECTORY DESTINATION /usr/local/awsmock/data/transfer)
    install(DIRECTORY DESTINATION /usr/local/awsmock/data/tmp)
    install(FILES dist/etc/awsmock.yml DESTINATION /usr/local/awsmock/etc)
    install(FILES dist/bin/awslocal DESTINATION /usr/local/awsmock/bin PERMISSIONS OWNER_EXECUTE OWNER_WRITE OWNER_READ GROUP_EXECUTE GROUP_READ WORLD_READ WORLD_EXECUTE)
    install(DIRECTORY dist/samples/ DESTINATION /usr/local/awsmock/samples)
endif ()

if (LINUX)
    install(FILES dist/etc/systemd/system/awsmock.service DESTINATION /etc/systemd/system)
elseif (APPLE)
    install(FILES dist/macos/de.jensvogt.awsmock.plist DESTINATION /Library/LaunchDaemons)
endif ()