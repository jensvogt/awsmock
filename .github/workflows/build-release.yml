name: Release + Build + Installer (Windows / macOS / Linux)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  #  QT_VERSION: "6.10.1"
  APP_NAME: "awsmock"
  INSTALLER_ID: "de.jensvogt.awsmock" # used for IFW package path

permissions:
  contents: write       # required for tagging + releasing
  pull-requests: write
  id-token: write
  pages: write

jobs:
  release-please:
    name: Create Release PR / Tag
    runs-on: ubuntu-latest

    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}

    steps:
      - name: Release Please
        id: release
        uses: googleapis/release-please-action@v4
        with:
          release-type: simple
          token: ${{ secrets.GH_AUTH_TOKEN }}

  #  build-windows:
  #    name: Build & Package (Windows)
  #    runs-on: windows-latest
  #    needs: release-please
  #    if: ${{ needs.release-please.outputs.release_created == 'true' }}
  #    env:
  ##      QT_DIR: "${{ github.workspace }}\\Qt"
  #      BUILD_DIR: "${{ github.workspace }}\\build-windows"
  #      PACKAGE_DIR: "${{ github.workspace }}\\package"
  #      SEMVER: "${{ needs.release-please.outputs.tag_name }}"
  #    steps:
  #      - name: Checkout
  #        uses: actions/checkout@v4
  #        with:
  #          fetch-depth: 0
  #
  #      - name: Normalize SEMVER
  #        run: echo "SEMVER=${SEMVER#v}" >> $GITHUB_ENV
  #
  #      - name: Setup MSVC environment
  #        uses: ilammy/msvc-dev-cmd@v1
  #        with:
  #          arch: x64
  #
  #      - name: Configure CMake (Windows)
  #        shell: powershell
  #        run: |
  #          cmake -S . -B $env:BUILD_DIR -G "Ninja" -DCMAKE_BUILD_TYPE=Release
  #
  #      - name: Build (Windows, parallel)
  #        shell: powershell
  #        run: |
  #          cmake --build $env:BUILD_DIR --config Release --parallel
  #
  #      - name: Create package sstructure
  #        shell: powershell
  #        run: |
  #          New-Item -ItemType Directory -Path $env:PACKAGE_DIR\bin -Force | Out-Null
  #          New-Item -ItemType Directory -Path $env:PACKAGE_DIR\etc -Force | Out-Null
  #          New-Item -ItemType Directory -Path $env:PACKAGE_DIR\log -Force | Out-Null
  #          New-Item -ItemType Directory -Path $env:PACKAGE_DIR\data -Force | Out-Null
  #          New-Item -ItemType Directory -Path $env:PACKAGE_DIR\data\s3 -Force | Out-Null
  #          New-Item -ItemType Directory -Path $env:PACKAGE_DIR\data\lambda -Force | Out-Null
  #          New-Item -ItemType Directory -Path $env:PACKAGE_DIR\data\application -Force | Out-Null
  #
  #      - name: Create ZIP archive (PowerShell)
  #        shell: pwsh
  #        run: |
  #          $source = "$env:PACKAGE_DIR"
  #          $zip = "$env:APP_NAME-$env:SEMVER-amd64.zip"
  #
  #          if (Test-Path $zip) {
  #            Remove-Item $zip -Force
  #          }
  #
  #          Add-Type -AssemblyName 'System.IO.Compression.FileSystem'
  #          [System.IO.Compression.ZipFile]::CreateFromDirectory($source, $zip)
  #
  #          Write-Host "Created ZIP: $zip"
  #
  #      - name: Upload Windows installer
  #        uses: actions/upload-artifact@v4
  #        with:
  #          name: installer-windows
  #          path: installer/${{ env.APP_NAME }}-${{ env.SEMVER }}-amd64.exe

  #  build-macos:
  #    name: Build & Package (macOS)
  #    runs-on: macos-latest
  #    needs: release-please
  #    if: ${{ needs.release-please.outputs.release_created == 'true' }}
  #    env:
  #      BUILD_DIR: "${{ github.workspace }}/build-macos"
  #      SEMVER: "${{ needs.release-please.outputs.tag_name }}"
  #      INSTALLER_DIR: "${{ github.workspace }}/installer"
  #      APP_NAME: "awsmock-qt-ui"
  #    steps:
  #      - name: Checkout
  #        uses: actions/checkout@v4
  #        with:
  #          fetch-depth: 0
  #
  #      - name: Install Qt via aqtinstall
  #        shell: bash
  #        run: |
  #          python3 -m venv ~/venv
  #          source ~/venv/bin/activate
  #          python3 -m pip install --upgrade pip
  #          python3 -m pip install aqtinstall
  #          ARCH="clang_64"
  #          python3 -m aqt install-qt mac desktop 6.10.1 $ARCH --outputdir "$HOME/Qt" --modules qtcharts qtimageformats
  #
  #      - name: Configure (macOS)
  #        shell: bash
  #        run: |
  #          mkdir -p $BUILD_DIR
  #          cmake -S . -B $BUILD_DIR -DCMAKE_BUILD_TYPE=Release -DQt6_DIR="$HOME/Qt/${{ env.QT_VERSION }}/macos/lib/cmake/Qt6"
  #
  #      - name: Build (macOS)
  #        shell: bash
  #        run: |
  #          cmake --build $BUILD_DIR --config Release --parallel $(sysctl -n hw.logicalcpu)
  #
  #      - name: macdeployqt + create DMG
  #        shell: bash
  #        run: |
  #          APP_BUNDLE="$BUILD_DIR/${APP_NAME}.app"
  #          if [ ! -d "$APP_BUNDLE" ]; then
  #            echo "App bundle not found at $APP_BUNDLE"
  #            ls -R "$BUILD_DIR"
  #            exit 1
  #          fi
  #          MACDEPLOYQT="$(find ${HOME}/Qt -type f -name macdeployqt | head -n 1)"
  #          "$MACDEPLOYQT" "$APP_BUNDLE"
  #          mkdir -p dist
  #          DMG_NAME="${APP_NAME}-${SEMVER}-macos.dmg"
  #          hdiutil create "dist/$DMG_NAME" -volname "${APP_NAME}" -srcfolder "$APP_BUNDLE" -ov -format UDZO
  #
  #      - name: Upload macOS DMG
  #        uses: actions/upload-artifact@v4
  #        with:
  #          name: installer-macos
  #          path: dist/${{ env.APP_NAME }}-${{ env.SEMVER }}-macos.dmg

  build-linux-deb:
    name: Build & Package (Linux DEB)
    runs-on: ubuntu-latest
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created == 'true' }}
    env:
      BUILD_DIR: "${{ github.workspace }}/build-linux"
      SEMVER: "${{ needs.release-please.outputs.tag_name }}"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Step 2: Install dependencies
      - name: Install system dependencies
        run: |
          sudo apt update
          sudo apt install -y build-essential cmake wget tar ninja-build ruby ruby-dev libmagic-dev doxygen zip unzip \
                              libtool pandoc libarchive-dev libmagic-dev libssh-dev libboost-all-dev
          sudo gem install --no-document fpm

      - name: Normalize version
        run: echo "SEMVER=${SEMVER#v}" >> $GITHUB_ENV

      - name: Create extern directories
        shell: bash
        run: |
          mkdir -p ${{ github.workspace }}/extern

      - name: Install JWT-CPP
        shell: bash
        run: |
          git clone https://github.com/Thalhammer/jwt-cpp.git
          cd jwt-cpp
          cmake . -DCMAKE_INSTALL_PREFIX=${{ github.workspace }}/extern
          cmake --build . --parallel $(nproc)
          cmake --install .

      - name: Install mongo-cxx-driver
        shell: bash
        run: |
          git clone -b releases/stable https://github.com/mongodb/mongo-cxx-driver.git
          cd mongo-cxx-driver
          cmake . -DCMAKE_CXX_STANDARD=17 -DCMAKE_INSTALL_PREFIX=${{ github.workspace }}/extern
          cmake --build . --config Release --parallel $(nproc)
          cmake --install .

      #      - name: Install Boost
      #        shell: bash
      #        run: |
      #          wget -nv https://archives.boost.io/release/1.89.0/source/boost_1_89_0.tar.gz
      #          tar -xzf boost_1_89_0.tar.gz
      #          cd boost_1_89_0
      #          ./bootstrap.sh --prefix=${{ github.workspace }}/extern
      #          ./b2 install -j$(nproc)

      - name: Build (Frontend)
        shell: bash
        run: |
          # Create a directory for the app
          mkdir -p ${{ github.workspace }}/frontend
          cd ${{ github.workspace }}/frontend

          # Clone the npm application repository (or download a tarball)
          git clone https://github.com/jensvogt/awsmock-ui
          cd awsmock-ui

          # Install dependencies
          npm install

          # Build the application (if it has a build step)
          npm run build
          find . 

      - name: Build (Linux)
        shell: bash
        run: |
          cmake -S . -B "$BUILD_DIR" \
            -DBUILD_DOCUMENTATION=ON \
            -DBSONCXX_INCLUDE_DIR=${{ github.workspace }}/extern/include/bsoncxx/v_noabi \
            -DMONGOCXX_INCLUDE_DIR=${{ github.workspace }}/extern/include/mongocxx/v_noabi \
            -DEXTERNAL_INCLUDE_DIR=${{ github.workspace }}/extern/include \
            -DEXTERNAL_LIB_DIR=${{ github.workspace }}/extern/lib
          cmake --build "$BUILD_DIR" --parallel $(nproc)

      - name: Prepare package structure
        run: |
          PACKAGE_DIR=package-deb
          echo "PACKAGE_DIR=$PACKAGE_DIR" >> $GITHUB_ENV
          
          mkdir -p $PACKAGE_DIR/DEBIAN
          mkdir -p $PACKAGE_DIR/usr/local/awsmock/bin
          mkdir -p $PACKAGE_DIR/usr/local/awsmock/etc
          mkdir -p $PACKAGE_DIR/usr/local/awsmock/log
          mkdir -p $PACKAGE_DIR/usr/local/awsmock/lib
          mkdir -p $PACKAGE_DIR/usr/local/awsmock/frontend
          mkdir -p $PACKAGE_DIR/usr/local/awsmock/data/s3
          mkdir -p $PACKAGE_DIR/usr/local/awsmock/data/sqs
          mkdir -p $PACKAGE_DIR/usr/local/awsmock/data/sns
          mkdir -p $PACKAGE_DIR/usr/local/awsmock/data/lambda
          mkdir -p $PACKAGE_DIR/usr/local/awsmock/data/application
          mkdir -p $PACKAGE_DIR/usr/local/share/man/man1
          mkdir -p $PACKAGE_DIR/etc/systemd/system
          mkdir -p $PACKAGE_DIR/etc/ld.so.conf
          mkdir -p $PACKAGE_DIR/DEBIAN

          # Copy your app
          cp $BUILD_DIR/src/manager/awsmockmgr $PACKAGE_DIR/usr/local/awsmock/bin/
          cp $BUILD_DIR/src/controller/awsmockctl $PACKAGE_DIR/usr/local/awsmock/bin/
          cp $BUILD_DIR/src/awslocal/awslocal $PACKAGE_DIR/usr/local/awsmock/bin/
          cp $BUILD_DIR/src/core/libawsmockcore.so $PACKAGE_DIR/usr/local/awsmock/lib/
          cp $BUILD_DIR/src/db/libawsmockdb.so $PACKAGE_DIR/usr/local/awsmock/lib/
          cp $BUILD_DIR/src/dto/libawsmockdto.so $PACKAGE_DIR/usr/local/awsmock/lib/
          cp $BUILD_DIR/src/service/libawsmocksrv.so $PACKAGE_DIR/usr/local/awsmock/lib/
          cp dist/etc/awsmock_linux.json $PACKAGE_DIR/usr/local/awsmock/etc/awsmock.json
          cp dist/etc/magic_linux.mgc $PACKAGE_DIR/usr/local/awsmock/etc/magic.mgc
          cp dist/etc/ssh_host_key $PACKAGE_DIR/usr/local/awsmock/etc/ssh_host_key
          cp dist/etc/systemd/system/awsmock.service $PACKAGE_DIR/etc/systemd/system
          cp docs/man/*.1 $PACKAGE_DIR/usr/local/share/man/man1
          cp -R frontend/awsmock-ui/dist/awsmock-ui/browser/* $PACKAGE_DIR/usr/local/awsmock/frontend

          # Create control file
          cat << EOF > $PACKAGE_DIR/DEBIAN/control
          Package: awsmock
          Version: ${SEMVER}
          Section: utils
          Priority: optional
          Architecture: amd64
          Maintainer: Jens Vogt <jens.vogt@opitz-consulting.com>
          Description: AWSMock local AWS emulator service
          Depends: systemd
          EOF

          # Create postinst
          cat << EOF > $PACKAGE_DIR/DEBIAN/postinst
          #!/bin/bash
          set -e
          systemctl daemon-reload
          systemctl enable awsmock.service
          systemctl restart awsmock.service || true
          ldconfig
          EOF

          # Create postrm
          cat << EOF > $PACKAGE_DIR/DEBIAN/postrm
          #!/bin/bash
          set -e          
          systemctl stop awsmock.service || true
          systemctl disable awsmock.service || true
          rm -rf /etc/systemd/system/awsmock.service
          rm -rf $PACKAGE_DIR/etc/ld.so.conf/awsmock.conf
          ldconfig
          EOF

          # Create ldconfig config
          cat << EOF > $PACKAGE_DIR/etc/ld.so.conf/awsmock.conf
          /usr/local/awsmock/lib
          EOF

          chmod 755 $PACKAGE_DIR/DEBIAN/postinst $PACKAGE_DIR/DEBIAN/postrm

      # Step 6: Build the .deb package
      - name: Build DEB with fpm
        run: |
          fpm -s dir -t deb \
            --name "${APP_NAME}" \
            --version "${SEMVER}" \
            --architecture amd64 \
            --package "${APP_NAME}-${SEMVER}-amd64.deb" \
            -C "${PACKAGE_DIR}" \
            .=/

      # Step 7: Upload .deb artifact
      - name: Upload .deb
        uses: actions/upload-artifact@v4
        with:
          name: deb-package-linux-${{ env.SEMVER }}
          path: ${{ env.APP_NAME }}-${{ env.SEMVER }}-amd64.deb
          overwrite: true

  build-linux-rpm:
    name: Build & Package (Linux RPM)
    runs-on: ubuntu-latest
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created == 'true' }}
    env:
      BUILD_DIR: "${{ github.workspace }}/build-linux"
      SEMVER: "${{ needs.release-please.outputs.tag_name }}"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Step 2: Install dependencies
      - name: Install system dependencies
        run: |
          sudo apt update
          sudo apt install -y build-essential cmake wget tar ninja-build ruby ruby-dev libmagic-dev doxygen zip unzip \
                              libtool pandoc libarchive-dev libmagic-dev libssh-dev libboost-all-dev
          sudo gem install --no-document fpm

      - name: Normalize version
        run: echo "SEMVER=${SEMVER#v}" >> $GITHUB_ENV

      - name: Create extern directories
        shell: bash
        run: |
          mkdir -p ${{ github.workspace }}/extern

      - name: Install JWT-CPP
        shell: bash
        run: |
          git clone https://github.com/Thalhammer/jwt-cpp.git
          cd jwt-cpp
          cmake . -DCMAKE_INSTALL_PREFIX=${{ github.workspace }}/extern
          cmake --build . --parallel $(nproc)
          cmake --install .

      - name: Install mongo-cxx-driver
        shell: bash
        run: |
          git clone -b releases/stable https://github.com/mongodb/mongo-cxx-driver.git
          cd mongo-cxx-driver
          cmake . -DCMAKE_CXX_STANDARD=17 -DCMAKE_INSTALL_PREFIX=${{ github.workspace }}/extern
          cmake --build . --config Release --parallel $(nproc)
          cmake --install .

      #      - name: Install Boost
      #        shell: bash
      #        run: |
      #          wget -nv https://archives.boost.io/release/1.89.0/source/boost_1_89_0.tar.gz
      #          tar -xzf boost_1_89_0.tar.gz
      #          cd boost_1_89_0
      #          ./bootstrap.sh --prefix=${{ github.workspace }}/extern
      #          ./b2 install -j$(nproc)

      - name: Build (Frontend)
        shell: bash
        run: |
          # Create a directory for the app
          mkdir -p ${{ github.workspace }}/frontend
          cd ${{ github.workspace }}/frontend

          # Clone the npm application repository (or download a tarball)
          git clone https://github.com/jensvogt/awsmock-ui
          cd awsmock-ui

          # Install dependencies
          npm install

          # Build the application (if it has a build step)
          npm run build
          find . 

      - name: Build (Linux)
        shell: bash
        run: |
          cmake -S . -B "$BUILD_DIR" \
            -DBUILD_DOCUMENTATION=ON \
            -DBSONCXX_INCLUDE_DIR=${{ github.workspace }}/extern/include/bsoncxx/v_noabi \
            -DMONGOCXX_INCLUDE_DIR=${{ github.workspace }}/extern/include/mongocxx/v_noabi \
            -DEXTERNAL_INCLUDE_DIR=${{ github.workspace }}/extern/include \
            -DEXTERNAL_LIB_DIR=${{ github.workspace }}/extern/lib
          cmake --build "$BUILD_DIR" --parallel $(nproc)

      - name: Prepare package structure
        run: |
          PACKAGE_DIR=package-rpm
          echo "PACKAGE_DIR=$PACKAGE_DIR" >> $GITHUB_ENV
          
          mkdir -p $PACKAGE_DIR/DEBIAN
          mkdir -p $PACKAGE_DIR/usr/local/awsmock/bin
          mkdir -p $PACKAGE_DIR/usr/local/awsmock/etc
          mkdir -p $PACKAGE_DIR/usr/local/awsmock/log
          mkdir -p $PACKAGE_DIR/usr/local/awsmock/lib
          mkdir -p $PACKAGE_DIR/usr/local/awsmock/data/s3
          mkdir -p $PACKAGE_DIR/usr/local/awsmock/data/sqs
          mkdir -p $PACKAGE_DIR/usr/local/awsmock/data/sns
          mkdir -p $PACKAGE_DIR/usr/local/awsmock/data/lambda
          mkdir -p $PACKAGE_DIR/usr/local/awsmock/data/application
          mkdir -p $PACKAGE_DIR/usr/local/awsmock/frontend
          mkdir -p $PACKAGE_DIR/usr/local/share/man/man1
          mkdir -p $PACKAGE_DIR/etc/systemd/system
          mkdir -p $PACKAGE_DIR/etc/ld.so.conf
          mkdir -p $PACKAGE_DIR/scripts
          
          # Copy your app
          cp $BUILD_DIR/src/manager/awsmockmgr $PACKAGE_DIR/usr/local/awsmock/bin/
          cp $BUILD_DIR/src/controller/awsmockctl $PACKAGE_DIR/usr/local/awsmock/bin/
          cp $BUILD_DIR/src/awslocal/awslocal $PACKAGE_DIR/usr/local/awsmock/bin/
          cp $BUILD_DIR/src/core/libawsmockcore.so $PACKAGE_DIR/usr/local/awsmock/lib/
          cp $BUILD_DIR/src/db/libawsmockdb.so $PACKAGE_DIR/usr/local/awsmock/lib/
          cp $BUILD_DIR/src/dto/libawsmockdto.so $PACKAGE_DIR/usr/local/awsmock/lib/
          cp $BUILD_DIR/src/service/libawsmocksrv.so $PACKAGE_DIR/usr/local/awsmock/lib/
          cp dist/etc/awsmock_linux.json $PACKAGE_DIR/usr/local/awsmock/etc/awsmock.json
          cp dist/etc/magic_linux.mgc $PACKAGE_DIR/usr/local/awsmock/etc/magic.mgc
          cp dist/etc/ssh_host_key $PACKAGE_DIR/usr/local/awsmock/etc/ssh_host_key
          cp dist/etc/systemd/system/awsmock.service $PACKAGE_DIR/etc/systemd/system
          cp docs/man/*.1 $PACKAGE_DIR/usr/local/share/man/man1
          cp -R frontend/awsmock-ui/dist/awsmock-ui/browser/* $PACKAGE_DIR/usr/local/awsmock/frontend
          
          # Create postinstall
          cat << EOF > $PACKAGE_DIR/scripts/postinstall.sh
          #!/bin/bash
          set -e
          systemctl daemon-reload
          systemctl enable awsmock.service
          systemctl restart awsmock.service || true
          ldconfig
          EOF
          
          # Create postremove
          cat << EOF > $PACKAGE_DIR/scripts/postremove.sh
          #!/bin/bash
          systemctl stop awsmock.service || true
          systemctl disable awsmock.service || true
          rm -f /etc/systemd/system/awsmock.service
          systemctl daemon-reload
          rm -f /etc/ld.so.conf/awsmock.conf
          ldconfig
          EOF
          
          chmod +x $PACKAGE_DIR/scripts/postinstall.sh $PACKAGE_DIR/scripts/postremove.sh

          # Create ldconfig config
          cat << EOF > $PACKAGE_DIR/etc/ld.so.conf/awsmock.conf
          /usr/local/awsmock/lib
          EOF

      - name: Build RPM using FPM
        run: |
          fpm -s dir -t rpm \
            -n awsmock \
            -v ${SEMVER} \
            --description "AWSMock â€“ Local AWS API mocking environment" \
            --url "https://github.com/jensvogt/awsmock" \
            --vendor "AWSMock Project" \
            --license "Apache-2.0" \
            --prefix / \
            --after-install $PACKAGE_DIR/scripts/postinstall.sh \
            --after-remove $PACKAGE_DIR/scripts/postremove.sh \
            $PACKAGE_DIR/=/

      # Step 7: Upload .deb artifact
      - name: Upload .rpm
        uses: actions/upload-artifact@v4
        with:
          name: rpm-package-linux-${{ env.SEMVER }}
          path: ${{ env.APP_NAME }}-${{ env.SEMVER }}-1.x86_64.rpm
          overwrite: true

  build-docker:
    name: "Build  Docker Image"
    runs-on: ubuntu-latest
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created == 'true' }}
    env:
      GH_TOKEN: ${{ github.token }}
      SEMVER: "${{ needs.release-please.outputs.tag_name }}"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build Docker
        run: |
          cd docker 
          docker build --no-cache --build-arg GH_TOKEN=${GH_TOKEN} -t awsmock:$SEMVER .

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Tag images
        run: |
          echo "SEMVER: ${SEMVER}"
          docker tag awsmock:$SEMVER ${{ secrets.DOCKER_USER }}/awsmock:$SEMVER
          docker push ${{ secrets.DOCKER_USER }}/awsmock:$SEMVER
          docker tag awsmock:$SEMVER ${{ secrets.DOCKER_USER }}/awsmock:latest
          docker push ${{ secrets.DOCKER_USER }}/awsmock:latest

  publish:
    name: Publish Release & Attach Installers
    runs-on: ubuntu-latest
    needs: [ release-please, build-linux-deb, build-linux-rpm ]
    env:
      SEMVER: "${{ needs.release-please.outputs.tag_name }}"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      #      - name: Download Windows installer
      #        uses: actions/download-artifact@v4
      #        with:
      #          name: installer-windows
      #          path: artifacts/windows

      #      - name: Download macOS installer
      #        uses: actions/download-artifact@v4
      #        with:
      #          name: installer-macos
      #          path: artifacts/macos

      #      - name: Download Linux installer
      #        uses: actions/download-artifact@v4
      #        with:
      #          name: installer-linux
      #          path: artifacts/linux

      - name: Download Linux Debian package
        uses: actions/download-artifact@v4
        with:
          name: deb-package-linux-${{ env.SEMVER }}
          path: artifacts/linux

      - name: Download Linux RPM package
        uses: actions/download-artifact@v4
        with:
          name: rpm-package-linux-${{ env.SEMVER }}
          path: artifacts/linux

      - name: Create GitHub Release (attach installers)
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/linux/*.deb
            artifacts/linux/*.rpm
          name: Release ${{ env.SEMVER }}
          tag_name: ${{ env.SEMVER }}
          body: "Automated release for ${{ env.SEMVER }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GH_AUTH_TOKEN }}

  deploy:
    needs:
      - publish
    runs-on: ubuntu-latest
    env:
      SEMVER: "${{ needs.release-please.outputs.tag_name }}"
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Normalize version
        run: echo "SEMVER=${SEMVER#v}" >> $GITHUB_ENV

      - name: Create site folder
        run: |
          mkdir public
          cp ./artifacts/deb-package-linux/*.deb public/ || true
          cp ./artifacts/rpm-package-linux/*.rpm public/ || true
          cp .github/pages/index.html public/index.html

      - name: Generate files.json
        run: |
          cd public
          echo '{ "downloads": [' > files.json
          first=true
          for f in *.{exe,deb,rpm,dmg}; do
            [ -f "$f" ] || continue
            if [ "$first" = true ]; then
              first=false
            else
              echo "," >> files.json
            fi
            size=$(stat -c%s "$f")
            sha=$(sha256sum "$f" | cut -d" " -f1)
            echo "  {\"file\": \"$f\", \"size\": $size, \"sha256\": \"$sha\"}" >> files.json
          done
          echo "]}" >> files.json

      - name: Upload GitHub Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: public

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4